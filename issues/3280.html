<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bug #3280: port forward not working with sNAT and multiWAN - NethServer 6 - NethServer.org</title>
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta content="authenticity_token" name="csrf-param" />
<meta content="O9v8tr7jDWYApOdi0G+30QrigCY6Zlvwpp0a1SfpBeU=" name="csrf-token" />
<link rel='shortcut icon' href='/favicon.ico?1457596383' />
<link href="../stylesheets/jquery/jquery-ui-1.9.2.css%3F1403512057" media="all" rel="stylesheet" type="text/css" />
<link href="../stylesheets/application.css" media="all" rel="stylesheet" type="text/css" />

<script src="../javascripts/jquery-1.8.3-ui-1.9.2-ujs-2.0.3.js%3F1403512056" type="text/javascript"></script>
<script src="../javascripts/application.js%3F1403512056" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>
<script src="../themes/nethserver../javascripts/theme.js%3F1403512057" type="text/javascript"></script>
<link href="/plugin_assets/openid_fix../stylesheets/openid.css%3F1403512057" media="screen" rel="stylesheet" type="text/css" />
<!-- page specific tags -->
    <link href="http://dev.nethserver.org/issues/3280.atom" rel="alternate" title="NethServer 6 - Bug #3280: port forward not working with sNAT and multiWAN" type="application/atom+xml" />
<script src="../javascripts/context_menu.js%3F1403512056" type="text/javascript"></script><link href="../stylesheets/context_menu.css%3F1403512057" media="screen" rel="stylesheet" type="text/css" /></head>
<body class="theme-Nethserver project-nethserver controller-issues action-show">
<div id="wrapper">
<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a href="/login" class="login">Sign in</a></li></ul>    </div>
    
    <ul><li><a href="/" class="home">Home</a></li>
<li><a href="/projects" class="projects">Projects</a></li>
<li><a href="http://www.redmine.org/guide" class="help">Help</a></li></ul></div>

<div id="header">
    <div id="quick-search">
        <form accept-charset="UTF-8" action="/projects/nethserver/search" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /></div>
        <input name="issues" type="hidden" value="1" />
        <label for='q'>
          <a href="/projects/nethserver/search" accesskey="4">Search</a>:
        </label>
        <input accesskey="f" class="small" id="q" name="q" size="20" type="text" />
</form>        
    </div>

    <h1>NethServer 6</h1>

    <div id="main-menu">
        <ul><li><a href="/projects/nethserver" class="overview">Overview</a></li>
<li><a href="/projects/nethserver/activity" class="activity">Activity</a></li>
<li><a href="/projects/nethserver/roadmap" class="roadmap">Roadmap</a></li>
<li><a href="/projects/nethserver/issues" class="issues selected">Issues</a></li>
<li><a href="/projects/nethserver/wiki" class="wiki">Wiki</a></li>
<li><a href="/projects/nethserver/repository" class="repository">Repository</a></li></ul>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/nethserver/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/nethserver/issues/report">Summary</a></li>

</ul>




<h3>Custom queries</h3>
<ul class="queries"><li><a href="/projects/nethserver/issues?query_id=60" class="query">6.6 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=64" class="query">6.7 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=65" class="query">6.8 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=66" class="query">6.9 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=12" class="query">@future/closed</a></li>
<li><a href="/projects/nethserver/issues?query_id=55" class="query">KNOWN_BUGS</a></li>
<li><a href="/projects/nethserver/issues?query_id=15" class="query">Lost+Found</a></li>
<li><a href="/projects/nethserver/issues?query_id=24" class="query">NEEDINFO</a></li>
<li><a href="/projects/nethserver/issues?query_id=26" class="query">ON_DEV</a></li>
<li><a href="/projects/nethserver/issues?query_id=27" class="query">ON_QA</a></li>
<li><a href="/projects/nethserver/issues?query_id=44" class="query">TODO Tasks</a></li>
<li><a href="/projects/nethserver/issues?query_id=54" class="query selected">UPDATES</a></li>
<li><a href="/projects/nethserver/issues?query_id=67" class="query">v6.10 (current)</a></li></ul>





        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #3280</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">
    <div class="next-prev-links contextual">
      <a href="/issues/3272" title="#3272">« Previous</a> |
      <a href="/issues/3287" title="#3287">Next »</a>
    </div>

  <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/c96c358beddd941e6188349f3c98ccd3?rating=PG&amp;size=50&amp;default=wavatar" ssl="false" title="" />

<div class="subject">
<div><h3>port forward not working with sNAT and multiWAN</h3></div>
</div>
        <p class="author">
        Added by <a href="/users/11" class="user active">Davide Marini</a> <a href="/projects/nethserver/activity?from=2015-10-07" title="10/07/2015 11:06 AM">almost 6 years</a> ago.
        Updated <a href="/projects/nethserver/activity?from=2015-11-13" title="11/13/2015 09:12 AM">over 5 years</a> ago.
        </p>

<table class="attributes">
<tr><th class="status">Status:</th><td class="status">CLOSED</td><th class="start-date">Start date:</th><td class="start-date"></td></tr><tr><th class="priority">Priority:</th><td class="priority">Normal</td><th class="due-date">Due date:</th><td class="due-date"></td></tr><tr><th class="assigned-to">Assignee:</th><td class="assigned-to">-</td><th class="progress">% Done:</th><td class="progress"><table class="progress progress-100" style="width: 80px;"><tr><td class="closed" style="width: 100%;"></td></tr></table><p class="percent">100%</p></td></tr><tr><th class="category">Category:</th><td class="category">nethserver-firewall-base</td><th></th><td></td></tr><tr><th class="fixed-version">Target version:</th><td class="fixed-version"><a href="/versions/214">v6.7</a></td><th></th><td></td></tr>
<tr>
	<th class="cf_15">Security class:</th><td class="cf_15"></td>
	<th class="cf_13">Resolution:</th><td class="cf_13"></td>
</tr>
<tr>
	<th class="cf_1">Affected version:</th><td class="cf_1"><a href="/versions/209">v6.6</a></td>
	<th class="cf_14">NEEDINFO:</th><td class="cf_14">No</td>
</tr>


</table>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Scenario:</p>


	<ul>
	<li>MultiWAN  (es: eth2,eth3) </li>
		<li>alias ips on reds</li>
		<li>sNAT 1:1 configured for an ip of non-red zone</li>
		<li>Let assume that sNAT is beetwen the local ip 192.168.1.1 and the alias eth2:1</li>
		<li>port forward rule for the ip 192.168.1.1 set on any IP (not the alias)</li>
	</ul>


Port Forward check:
	<ul>
	<li>When connections from outside are made on the same red interface of the sNAT everything is working </li>
		<li>When connections from outside are made on the OTHER red interface port forwarding is not working</li>
	</ul>


	<p>The packet come in from the other red interface,  flow to the destination host, the host answer to the request correctly but the packets are sent in the wrong interface (always eth2) : the response has the right destination ip (the originating one from outside) but flow to the wrong interface</p>
  </div>
</div>






</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-firewall-base/revisions/d02a1fe1a3e074e602b47c58f4365054904562f9" title="Revision d02a1fe1">Revision d02a1fe1</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-10-19" title="10/19/2015 08:25 AM">almost 6 years</a> ago</span></p>
    <div class="wiki">
        <p>rtrules: fix port forward with sNAT and MultiWAN. Refs <a href="/issues/3280" class="issue tracker-1 status-5 priority-4 priority-default closed" title="port forward not working with sNAT and multiWAN (CLOSED)">#3280</a></p>
    </div>
    </div>

</div>

<div id="history">
<h3>History</h3>
  <div id="change-16312" class="journal has-notes">
    <div id="note-1">
    <h4><a href="/issues/3280#note-1" class="journal-link">#1</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/c96c358beddd941e6188349f3c98ccd3?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/11" class="user active">Davide Marini</a> <a href="/projects/nethserver/activity?from=2015-10-07" title="10/07/2015 11:45 AM">almost 6 years</a> ago</h4>

    <div class="wiki" id="journal-16312-notes"><p>The problem seems to be caused by rtrules:</p>


<pre>
0: from all lookup local 
999: from all lookup main 
1900: from 192.168.1.1 lookup itcpr 
10000: from all fwmark 0x10000/0xf0000 lookup itcpr 
10001: from all fwmark 0x20000/0xf0000 lookup itcsc 
.
.
.
32765: from all lookup balance 
32767: from all lookup default 
</pre>

	<p>the rule</p>


	<p>1900: from 192.168.1.1 lookup itcpr</p>


	<p>has a too high priority and all the packets from 192.168.1.1 are sent to the alias interface even if the connection is from outside.</p>


	<p>I would like that only new connections from local host 192.1681.1 are forced to the ethx interface of the alias, other connections should follow standard rules,<br />to have this behavior it should be enough to have a lower priority for snat rules.</p>


<pre>
0: from all lookup local 
999: from all lookup main 
10000: from all fwmark 0x10000/0xf0000 lookup itcpr 
10001: from all fwmark 0x20000/0xf0000 lookup itcsc 
11000: from 192.168.1.1 lookup itcpr 
.
.
.
32765: from all lookup balance 
32767: from all lookup default 
</pre>

	<p>It can be done easily with this little change:</p>


<pre>
[root@nethserver ~]# diff -u 30nat.ori  /etc/e-smith/templates/etc/shorewall/rtrules/30nat 
--- 30nat.ori   2015-10-07 16:44:48.039206391 +0200
+++ /etc/e-smith/templates/etc/shorewall/rtrules/30nat  2015-10-07 16:37:39.867472712 +0200
@@ -24,7 +24,7 @@
             foreach $j (@providers) {
                 my $provider_name = $j-&gt;{'name'};
                 if($j-&gt;{'interface'} eq $interface) {
-                    $OUT .= "$internal_ip\t\t-\t\t\t$provider_name\t\t1900\n";
+                    $OUT .= "$internal_ip\t\t-\t\t\t$provider_name\t\t11000\n";
                 }
             }
         }

</pre>

	<p>I already checked it and it seems to work fine without any drawback.</p></div>
    </div>
  </div>
  
  <div id="change-16378" class="journal has-details">
    <div id="note-2">
    <h4><a href="/issues/3280#note-2" class="journal-link">#2</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-10-15" title="10/15/2015 11:54 AM">almost 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>nethserver-firewall-base</i></li>
       <li><strong>Status</strong> changed from <i>NEW</i> to <i>TRIAGED</i></li>
       <li><strong>Target version</strong> set to <i>v6.7</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>20</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-16388" class="journal has-details">
    <div id="note-3">
    <h4><a href="/issues/3280#note-3" class="journal-link">#3</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-10-19" title="10/19/2015 08:17 AM">almost 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>TRIAGED</i> to <i>ON_DEV</i></li>
       <li><strong>Assignee</strong> set to <i>Giacomo Sanchietti</i></li>
       <li><strong>% Done</strong> changed from <i>20</i> to <i>30</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-16390" class="journal has-notes has-details">
    <div id="note-4">
    <h4><a href="/issues/3280#note-4" class="journal-link">#4</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-10-19" title="10/19/2015 08:25 AM">almost 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_DEV</i> to <i>MODIFIED</i></li>
       <li><strong>% Done</strong> changed from <i>30</i> to <i>60</i></li>
    </ul>
    <div class="wiki" id="journal-16390-notes"><p>Proposed patch has been merged.</p></div>
    </div>
  </div>
  
  <div id="change-16392" class="journal has-notes has-details">
    <div id="note-5">
    <h4><a href="/issues/3280#note-5" class="journal-link">#5</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-10-19" title="10/19/2015 08:28 AM">almost 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>MODIFIED</i> to <i>ON_QA</i></li>
       <li><strong>Assignee</strong> deleted (<del><i>Giacomo Sanchietti</i></del>)</li>
       <li><strong>% Done</strong> changed from <i>60</i> to <i>70</i></li>
    </ul>
    <div class="wiki" id="journal-16392-notes">Packages in nethserver-testing:
	<ul>
	<li>nethserver-firewall-base-2.8.0-1.3.gd02a1fe.ns6.noarch.rpm</li>
		<li>nethserver-firewall-base-ui-2.8.0-1.3.gd02a1fe.ns6.noarch.rpm</li>
	</ul>


<strong>Test case</strong>
	<ul>
	<li>Check the bug is not reproducible</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-16620" class="journal has-details">
    <div id="note-6">
    <h4><a href="/issues/3280#note-6" class="journal-link">#6</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-11-11" title="11/11/2015 05:53 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Assignee</strong> set to <i>Giacomo Sanchietti</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-16621" class="journal has-notes has-details">
    <div id="note-7">
    <h4><a href="/issues/3280#note-7" class="journal-link">#7</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-11-11" title="11/11/2015 06:26 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_QA</i> to <i>VERIFIED</i></li>
       <li><strong>Assignee</strong> deleted (<del><i>Giacomo Sanchietti</i></del>)</li>
       <li><strong>% Done</strong> changed from <i>70</i> to <i>90</i></li>
    </ul>
    <div class="wiki" id="journal-16621-notes"><p><ins>System and  Package Version installed</ins></p>


	<p>Package Installed: <br />nethserver-firewall-base-ui-2.8.0-1.18.gfc25d0e.ns6.noarch<br />nethserver-firewall-base-2.8.0-1.18.gfc25d0e.ns6.noarch</p>


	<p><ins>Test Original Problem</ins><br />IP rule placed in the wrong order</p>


	<p><ins>Install Updated Package</ins><br /><pre>
yum --enablerepo=nethserver-testing update nethserver-firewall-base*
</pre></p>


	<p><ins>Test Results after update</ins><br />Natted host is 192.168.5.22.<br /><pre>
[root@localhost ~]# ip ru
0:    from all lookup local 
999:    from all lookup main 
10000:    from all fwmark 0x10000/0xf0000 lookup p1 
10001:    from all fwmark 0x20000/0xf0000 lookup p2 
11000:    from 192.168.5.22 lookup p1 
20000:    from 10.10.10.4 lookup p1 
20000:    from 10.2.3.2 lookup p1 
20000:    from 10.0.2.4 lookup p2 
32765:    from all lookup balance 
32767:    from all lookup default 
</pre></p>


	<p><ins>Verified Or Reopen</ins><br />Verified</p></div>
    </div>
  </div>
  
  <div id="change-16625" class="journal has-notes has-details">
    <div id="note-8">
    <h4><a href="/issues/3280#note-8" class="journal-link">#8</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-11-11" title="11/11/2015 10:53 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>VERIFIED</i> to <i>CLOSED</i></li>
       <li><strong>% Done</strong> changed from <i>90</i> to <i>100</i></li>
    </ul>
    <div class="wiki" id="journal-16625-notes">Released in nethserver-updates:
	<ul>
	<li>nethserver-firewall-base-ui-2.9.0-1.ns6.noarch.rpm</li>
		<li>nethserver-firewall-base-2.9.0-1.ns6.noarch.rpm</li>
	</ul></div>
    </div>
  </div>
  


</div>


<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>

<p class="other-formats">Also available in:  <span><a href="/issues/3280.atom" class="atom" rel="nofollow">Atom</a></span>
  <span><a href="/issues/3280.pdf" class="pdf" rel="nofollow">PDF</a></span>
</p>



<script type="text/javascript">
//<![CDATA[
contextMenuInit('/issues/context_menu')
//]]>
</script>

        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Copyright © 2012-2021 nethserver.org
  </div></div>
</div>
</div>
</div>

</body>
</html>
