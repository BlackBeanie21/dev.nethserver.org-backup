<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Enhancement #3192: Modify NAT 1:1 behavior  (only source NAT) - NethServer 6 - NethServer.org</title>
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta content="authenticity_token" name="csrf-param" />
<meta content="O9v8tr7jDWYApOdi0G+30QrigCY6Zlvwpp0a1SfpBeU=" name="csrf-token" />
<link rel='shortcut icon' href='/favicon.ico?1457596383' />
<link href="../stylesheets/jquery/jquery-ui-1.9.2.css%3F1403512057" media="all" rel="stylesheet" type="text/css" />
<link href="../stylesheets/application.css" media="all" rel="stylesheet" type="text/css" />

<script src="../javascripts/jquery-1.8.3-ui-1.9.2-ujs-2.0.3.js%3F1403512056" type="text/javascript"></script>
<script src="../javascripts/application.js%3F1403512056" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>
<script src="../themes/nethserver../javascripts/theme.js%3F1403512057" type="text/javascript"></script>
<link href="/plugin_assets/openid_fix../stylesheets/openid.css%3F1403512057" media="screen" rel="stylesheet" type="text/css" />
<!-- page specific tags -->
    <link href="http://dev.nethserver.org/issues/3192.atom" rel="alternate" title="NethServer 6 - Enhancement #3192: Modify NAT 1:1 behavior  (only source NAT)" type="application/atom+xml" />
<script src="../javascripts/context_menu.js%3F1403512056" type="text/javascript"></script><link href="../stylesheets/context_menu.css%3F1403512057" media="screen" rel="stylesheet" type="text/css" /></head>
<body class="theme-Nethserver project-nethserver controller-issues action-show">
<div id="wrapper">
<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a href="/login" class="login">Sign in</a></li></ul>    </div>
    
    <ul><li><a href="/" class="home">Home</a></li>
<li><a href="/projects" class="projects">Projects</a></li>
<li><a href="http://www.redmine.org/guide" class="help">Help</a></li></ul></div>

<div id="header">
    <div id="quick-search">
        <form accept-charset="UTF-8" action="/projects/nethserver/search" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /></div>
        <input name="issues" type="hidden" value="1" />
        <label for='q'>
          <a href="/projects/nethserver/search" accesskey="4">Search</a>:
        </label>
        <input accesskey="f" class="small" id="q" name="q" size="20" type="text" />
</form>        
    </div>

    <h1>NethServer 6</h1>

    <div id="main-menu">
        <ul><li><a href="/projects/nethserver" class="overview">Overview</a></li>
<li><a href="/projects/nethserver/activity" class="activity">Activity</a></li>
<li><a href="/projects/nethserver/roadmap" class="roadmap">Roadmap</a></li>
<li><a href="/projects/nethserver/issues" class="issues selected">Issues</a></li>
<li><a href="/projects/nethserver/wiki" class="wiki">Wiki</a></li>
<li><a href="/projects/nethserver/repository" class="repository">Repository</a></li></ul>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/nethserver/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/nethserver/issues/report">Summary</a></li>

</ul>




<h3>Custom queries</h3>
<ul class="queries"><li><a href="/projects/nethserver/issues?query_id=60" class="query">6.6 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=64" class="query">6.7 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=65" class="query">6.8 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=66" class="query">6.9 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=12" class="query">@future/closed</a></li>
<li><a href="/projects/nethserver/issues?query_id=55" class="query">KNOWN_BUGS</a></li>
<li><a href="/projects/nethserver/issues?query_id=15" class="query">Lost+Found</a></li>
<li><a href="/projects/nethserver/issues?query_id=24" class="query">NEEDINFO</a></li>
<li><a href="/projects/nethserver/issues?query_id=26" class="query">ON_DEV</a></li>
<li><a href="/projects/nethserver/issues?query_id=27" class="query">ON_QA</a></li>
<li><a href="/projects/nethserver/issues?query_id=44" class="query">TODO Tasks</a></li>
<li><a href="/projects/nethserver/issues?query_id=54" class="query selected">UPDATES</a></li>
<li><a href="/projects/nethserver/issues?query_id=67" class="query">v6.10 (current)</a></li></ul>





        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Enhancement #3192</h2>

<div class="issue tracker-6 status-5 priority-4 priority-default closed details">
    <div class="next-prev-links contextual">
      <a href="/issues/3210" title="#3210">« Previous</a> |
      <a href="/issues/3219" title="#3219">Next »</a>
    </div>

  <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/c96c358beddd941e6188349f3c98ccd3?rating=PG&amp;size=50&amp;default=wavatar" ssl="false" title="" />

<div class="subject">
<div><h3>Modify NAT 1:1 behavior  (only source NAT)</h3></div>
</div>
        <p class="author">
        Added by <a href="/users/11" class="user active">Davide Marini</a> <a href="/projects/nethserver/activity?from=2015-06-09" title="06/09/2015 12:03 PM">about 6 years</a> ago.
        Updated <a href="/projects/nethserver/activity?from=2015-07-15" title="07/15/2015 03:11 AM">about 6 years</a> ago.
        </p>

<table class="attributes">
<tr><th class="status">Status:</th><td class="status">CLOSED</td><th class="start-date">Start date:</th><td class="start-date"></td></tr><tr><th class="priority">Priority:</th><td class="priority">Normal</td><th class="due-date">Due date:</th><td class="due-date"></td></tr><tr><th class="assigned-to">Assignee:</th><td class="assigned-to">-</td><th class="progress">% Done:</th><td class="progress"><table class="progress progress-100" style="width: 80px;"><tr><td class="closed" style="width: 100%;"></td></tr></table><p class="percent">100%</p></td></tr><tr><th class="category">Category:</th><td class="category">nethserver-firewall-base</td><th></th><td></td></tr><tr><th class="fixed-version">Target version:</th><td class="fixed-version"><a href="/versions/209">v6.6</a></td><th></th><td></td></tr>
<tr>
	<th class="cf_13">Resolution:</th><td class="cf_13"></td>
	<th class="cf_14">NEEDINFO:</th><td class="cf_14">No</td>
</tr>


</table>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>The actual implementation of NAT1:1 perform a full NAT1:1  (in/out),  but for the 99% of needs only a source nat shoud be the best option, because NethServer act as a firewall, not just a router, so all the servers should be behind the firewall and all the VPNs should be done with NethServer avoiding the needs of a DNAT for the incoming packets.</p>


	<ul>
	<li>natting of the incoming traffic usually is not needed,  port forwarding is enough for the majority of the applications</li>
	</ul>


	<ul>
	<li>one of the most common case is to nat a mail server to force it sending email with an alias ip: a source nat is enough to do this<br /> for receiving the email a port forward is enough and if somebody want to scan the incoming emails with nethserver it's still possibile to configure the email section (that would  not be possibile with full NAT 1:1 )</li>
	</ul>
  </div>
</div>






</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-firewall-base/revisions/9f6691174c5aab4ed85a2208cb58655cca118c24" title="Revision 9f669117">Revision 9f669117</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-25" title="06/25/2015 05:35 AM">about 6 years</a> ago</span></p>
    <div class="wiki">
        <p>Implement NAT 1:1 with source NAT. Refs <a href="/issues/3192" class="issue tracker-6 status-5 priority-4 priority-default closed" title="Modify NAT 1:1 behavior  (only source NAT) (CLOSED)">#3192</a></p>
    </div>
    </div>
    <div class="changeset even">
    <p><a href="/projects/nethserver/repository/nethserver-firewall-base/revisions/0713cf9665b9930dfc5006cd6c7e7777d5c50ae1" title="Revision 0713cf96">Revision 0713cf96</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-25" title="06/25/2015 05:47 AM">about 6 years</a> ago</span></p>
    <div class="wiki">
        <p>Language: add missing labels, change title. Refs <a href="/issues/3192" class="issue tracker-6 status-5 priority-4 priority-default closed" title="Modify NAT 1:1 behavior  (only source NAT) (CLOSED)">#3192</a></p>
    </div>
    </div>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-firewall-base/revisions/c1d1c0ea45a915e8e51452974bd1b2cd942d3e7c" title="Revision c1d1c0ea">Revision c1d1c0ea</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-25" title="06/25/2015 05:58 AM">about 6 years</a> ago</span></p>
    <div class="wiki">
        <p>Translations: add missing resources. Refs <a href="/issues/3192" class="issue tracker-6 status-5 priority-4 priority-default closed" title="Modify NAT 1:1 behavior  (only source NAT) (CLOSED)">#3192</a></p>
    </div>
    </div>

</div>

<div id="history">
<h3>History</h3>
  <div id="change-15523" class="journal has-notes">
    <div id="note-1">
    <h4><a href="/issues/3192#note-1" class="journal-link">#1</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/c96c358beddd941e6188349f3c98ccd3?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/11" class="user active">Davide Marini</a> <a href="/projects/nethserver/activity?from=2015-06-09" title="06/09/2015 12:05 PM">about 6 years</a> ago</h4>

    <div class="wiki" id="journal-15523-notes"><p>I suggest to modify the NAT 1:1 behaviour so that it work with shorewall's masq module (and not nat) :</p>


<pre>
[root@nethserver ~]# cat /etc/e-smith/templates-custom/etc/shorewall/masq/15snat 
#
# 20nat
#
{
    # import db
    use esmith::NetworksDB;
    use NethServer::Firewall;

    # open db
    my $ndb = esmith::NetworksDB-&gt;open_ro();
    my $hdb = esmith::HostsDB-&gt;open_ro();
    my $fw = new NethServer::Firewall();

    # get aliases of red interfaces
    foreach my $j ($ndb-&gt;red) {
        my $red_inter = $j-&gt;key;
        foreach my $k ($ndb-&gt;aliases) {
            if($k-&gt;key =~ /^$red_inter:[\d]/) {
                push @red_aliases, $k;
            }
        }
    }

    # get info from db
    foreach my $i (@red_aliases) {
        # get alias interface name
        my $alias_interface = $i-&gt;key;

        # get interface name
        my @interface_parts = split /:/, $alias_interface;
        my $interface = $interface_parts[0];

        # get alias interface ip
        my $alias_interface_ip = $i-&gt;prop('ipaddr');    

        # get ip from firewall obj
        my $fw_obj = $i-&gt;prop('FwObjectNat');

        # if nat exist add it
        if($fw_obj ne "") {
            # get hostname
            $internal_ip = $fw-&gt;getAddress($fw_obj);

            # print config
            $OUT .= "$interface\t$internal_ip\t$alias_interface_ip\n";
        }
    }
}

</pre></div>
    </div>
  </div>
  
  <div id="change-15544" class="journal has-details">
    <div id="note-2">
    <h4><a href="/issues/3192#note-2" class="journal-link">#2</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-10" title="06/10/2015 03:21 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Target version</strong> set to <i>~FUTURE</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-15620" class="journal has-notes has-details">
    <div id="note-3">
    <h4><a href="/issues/3192#note-3" class="journal-link">#3</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-12" title="06/12/2015 10:48 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>nethserver-firewall-base</i></li>
       <li><strong>Status</strong> changed from <i>NEW</i> to <i>TRIAGED</i></li>
       <li><strong>Target version</strong> changed from <i>~FUTURE</i> to <i>v6.6</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>20</i></li>
    </ul>
    <div class="wiki" id="journal-15620-notes"><p>Also create an empty fragment for: <code>/etc/e-smith/templates/etc/shorewall/nat/20nat</code>.</p></div>
    </div>
  </div>
  
  <div id="change-15770" class="journal has-details">
    <div id="note-4">
    <h4><a href="/issues/3192#note-4" class="journal-link">#4</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-25" title="06/25/2015 05:19 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>TRIAGED</i> to <i>ON_DEV</i></li>
       <li><strong>Assignee</strong> set to <i>Giacomo Sanchietti</i></li>
       <li><strong>% Done</strong> changed from <i>20</i> to <i>30</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-15771" class="journal has-details">
    <div id="note-5">
    <h4><a href="/issues/3192#note-5" class="journal-link">#5</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-25" title="06/25/2015 05:51 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_DEV</i> to <i>MODIFIED</i></li>
       <li><strong>% Done</strong> changed from <i>30</i> to <i>60</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-15772" class="journal has-notes has-details">
    <div id="note-6">
    <h4><a href="/issues/3192#note-6" class="journal-link">#6</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-06-25" title="06/25/2015 05:54 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>MODIFIED</i> to <i>ON_QA</i></li>
       <li><strong>Assignee</strong> deleted (<del><i>Giacomo Sanchietti</i></del>)</li>
       <li><strong>% Done</strong> changed from <i>60</i> to <i>70</i></li>
    </ul>
    <div class="wiki" id="journal-15772-notes"><p>Package in nethserve-testing:</p>


<strong>Test case</strong>
	<ul>
	<li>Install the old RPM</li>
		<li>Configure a NAT 1:1</li>
		<li>Install the new RPM</li>
		<li>Check <code>/etc/shorewall/nat</code> contains only command</li>
		<li>Check <code>/etc/shorwall/masq</code> contains the NAT configuration. The line should be something like this:<br /><pre>
eth1    192.168.1.22    9.8.7.6
</pre></li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-15793" class="journal has-notes">
    <div id="note-7">
    <h4><a href="/issues/3192#note-7" class="journal-link">#7</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/a51a6d0dfe89fa5bf19f241d5cdebc5e?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/326" class="user active">dz0 0te</a> <a href="/projects/nethserver/activity?from=2015-06-27" title="06/27/2015 09:20 AM">about 6 years</a> ago</h4>

    <div class="wiki" id="journal-15793-notes"><p>what is the package to be tested? I guess nethserver-firewall-base-2.6.3-1.4.gae44624.ns6.noarch.rpm but just to be sure...</p></div>
    </div>
  </div>
  
  <div id="change-15794" class="journal has-notes">
    <div id="note-8">
    <h4><a href="/issues/3192#note-8" class="journal-link">#8</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/d1393faf88bfcbb0b41ce36307b6a143?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/8" class="user active">Filippo Carletti</a> <a href="/projects/nethserver/activity?from=2015-06-27" title="06/27/2015 10:37 AM">about 6 years</a> ago</h4>

    <div class="wiki" id="journal-15794-notes"><p>dz0 0te wrote:</p>


<blockquote>

	<p>what is the package to be tested? I guess nethserver-firewall-base-2.6.3-1.4.gae44624.ns6.noarch.rpm but just to be sure...</p>


</blockquote>

	<p>Yes.<br />nethserver-firewall-base-2.6.3-1.4.gae44624.ns6.noarch</p></div>
    </div>
  </div>
  
  <div id="change-15795" class="journal has-details">
    <div id="note-9">
    <h4><a href="/issues/3192#note-9" class="journal-link">#9</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/a51a6d0dfe89fa5bf19f241d5cdebc5e?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/326" class="user active">dz0 0te</a> <a href="/projects/nethserver/activity?from=2015-06-27" title="06/27/2015 11:13 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Assignee</strong> set to <i>dz0 0te</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-15796" class="journal has-notes has-details">
    <div id="note-10">
    <h4><a href="/issues/3192#note-10" class="journal-link">#10</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/a51a6d0dfe89fa5bf19f241d5cdebc5e?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/326" class="user active">dz0 0te</a> <a href="/projects/nethserver/activity?from=2015-06-27" title="06/27/2015 11:24 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_QA</i> to <i>VERIFIED</i></li>
       <li><strong>Assignee</strong> deleted (<del><i>dz0 0te</i></del>)</li>
       <li><strong>% Done</strong> changed from <i>70</i> to <i>90</i></li>
    </ul>
    <div class="wiki" id="journal-15796-notes"><p><ins>System and  Package Version installed</ins><br />VM KVM - Clean install of Nethserver 6.6 fully updated<br />Package Installed: nethserver-firewall-base-2.6.3-1.ns6.noarch<br />Other Package installed: Basic firewall</p>


	<p><ins>Test Original Problem</ins><br />Enhancement<br />Before the update configured a NAT 1:1</p>


	<p><ins>Install Updated Package</ins><br /><pre>
yum --enablerepo=nethserver-testing update nethserver-firewall-base-2.6.3-1.4.gae44624.ns6
</pre></p>


	<p><ins>Test Results after update</ins><br />cat /etc/shorewall/nat <br /><pre>
###############################################################################
#EXTERNAL       INTERFACE       INTERNAL        ALL             LOCAL
# Content removed. See: http://dev.nethserver.org/issues/3192
</pre></p>


	<p>cat /etc/shorewall/masq<br /><pre>
######################################################################################################
#INTERFACE:DEST         SOURCE          ADDRESS         PROTO   PORT(S) IPSEC   MARK    USER/   SWITCH
#                                                                                       GROUP
#
# 20nat
#
eth1    192.168.100.10   1.2.3.4
</pre></p>


	<p><ins>Note</ins><br />...</p></div>
    </div>
  </div>
  
  <div id="change-15916" class="journal has-notes has-details">
    <div id="note-11">
    <h4><a href="/issues/3192#note-11" class="journal-link">#11</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2015-07-15" title="07/15/2015 03:11 AM">about 6 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>VERIFIED</i> to <i>CLOSED</i></li>
       <li><strong>% Done</strong> changed from <i>90</i> to <i>100</i></li>
    </ul>
    <div class="wiki" id="journal-15916-notes">Released in nethserver-updates:
	<ul>
	<li>nethserver-firewall-base-2.6.4-1.ns6.noarch.rpm</li>
	</ul></div>
    </div>
  </div>
  


</div>


<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>

<p class="other-formats">Also available in:  <span><a href="/issues/3192.atom" class="atom" rel="nofollow">Atom</a></span>
  <span><a href="/issues/3192.pdf" class="pdf" rel="nofollow">PDF</a></span>
</p>



<script type="text/javascript">
//<![CDATA[
contextMenuInit('/issues/context_menu')
//]]>
</script>

        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Copyright © 2012-2021 nethserver.org
  </div></div>
</div>
</div>
</div>

</body>
</html>
