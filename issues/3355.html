<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Feature #3355: Let&#x27;s Encrypt (partial) support  - NethServer 6 - NethServer.org</title>
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta content="authenticity_token" name="csrf-param" />
<meta content="O9v8tr7jDWYApOdi0G+30QrigCY6Zlvwpp0a1SfpBeU=" name="csrf-token" />
<link rel='shortcut icon' href='/favicon.ico?1457596383' />
<link href="../stylesheets/jquery/jquery-ui-1.9.2.css%3F1403512057" media="all" rel="stylesheet" type="text/css" />
<link href="../stylesheets/application.css" media="all" rel="stylesheet" type="text/css" />

<script src="../javascripts/jquery-1.8.3-ui-1.9.2-ujs-2.0.3.js%3F1403512056" type="text/javascript"></script>
<script src="../javascripts/application.js%3F1403512056" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>
<script src="../themes/nethserver../javascripts/theme.js%3F1403512057" type="text/javascript"></script>
<link href="/plugin_assets/openid_fix../stylesheets/openid.css%3F1403512057" media="screen" rel="stylesheet" type="text/css" />
<!-- page specific tags -->
    <link href="http://dev.nethserver.org/issues/3355.atom" rel="alternate" title="NethServer 6 - Feature #3355: Let&#x27;s Encrypt (partial) support " type="application/atom+xml" />
<script src="../javascripts/context_menu.js%3F1403512056" type="text/javascript"></script><link href="../stylesheets/context_menu.css%3F1403512057" media="screen" rel="stylesheet" type="text/css" /></head>
<body class="theme-Nethserver project-nethserver controller-issues action-show">
<div id="wrapper">
<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a href="/login" class="login">Sign in</a></li></ul>    </div>
    
    <ul><li><a href="/" class="home">Home</a></li>
<li><a href="/projects" class="projects">Projects</a></li>
<li><a href="http://www.redmine.org/guide" class="help">Help</a></li></ul></div>

<div id="header">
    <div id="quick-search">
        <form accept-charset="UTF-8" action="/projects/nethserver/search" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /></div>
        <input name="issues" type="hidden" value="1" />
        <label for='q'>
          <a href="/projects/nethserver/search" accesskey="4">Search</a>:
        </label>
        <input accesskey="f" class="small" id="q" name="q" size="20" type="text" />
</form>        
    </div>

    <h1>NethServer 6</h1>

    <div id="main-menu">
        <ul><li><a href="/projects/nethserver" class="overview">Overview</a></li>
<li><a href="/projects/nethserver/activity" class="activity">Activity</a></li>
<li><a href="/projects/nethserver/roadmap" class="roadmap">Roadmap</a></li>
<li><a href="/projects/nethserver/issues" class="issues selected">Issues</a></li>
<li><a href="/projects/nethserver/wiki" class="wiki">Wiki</a></li>
<li><a href="/projects/nethserver/repository" class="repository">Repository</a></li></ul>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/nethserver/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/nethserver/issues/report">Summary</a></li>

</ul>




<h3>Custom queries</h3>
<ul class="queries"><li><a href="/projects/nethserver/issues?query_id=60" class="query">6.6 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=64" class="query">6.7 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=65" class="query">6.8 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=66" class="query">6.9 (changelog)</a></li>
<li><a href="/projects/nethserver/issues?query_id=12" class="query">@future/closed</a></li>
<li><a href="/projects/nethserver/issues?query_id=55" class="query">KNOWN_BUGS</a></li>
<li><a href="/projects/nethserver/issues?query_id=15" class="query">Lost+Found</a></li>
<li><a href="/projects/nethserver/issues?query_id=24" class="query">NEEDINFO</a></li>
<li><a href="/projects/nethserver/issues?query_id=26" class="query">ON_DEV</a></li>
<li><a href="/projects/nethserver/issues?query_id=27" class="query">ON_QA</a></li>
<li><a href="/projects/nethserver/issues?query_id=44" class="query">TODO Tasks</a></li>
<li><a href="/projects/nethserver/issues?query_id=54" class="query selected">UPDATES</a></li>
<li><a href="/projects/nethserver/issues?query_id=67" class="query">v6.10 (current)</a></li></ul>





        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Feature #3355</h2>

<div class="issue tracker-2 status-5 priority-4 priority-default closed details">
    <div class="next-prev-links contextual">
      <a href="/issues/3362" title="#3362">« Previous</a> |
      <a href="/issues/3357" title="#3357">Next »</a>
    </div>

  <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=50&amp;default=wavatar" ssl="false" title="" />

<div class="subject">
<div><h3>Let&#x27;s Encrypt (partial) support </h3></div>
</div>
        <p class="author">
        Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 03:06 AM">over 5 years</a> ago.
        Updated <a href="/projects/nethserver/activity?from=2016-02-26" title="02/26/2016 08:44 AM">over 5 years</a> ago.
        </p>

<table class="attributes">
<tr><th class="status">Status:</th><td class="status">CLOSED</td><th class="start-date">Start date:</th><td class="start-date"></td></tr><tr><th class="priority">Priority:</th><td class="priority">Normal</td><th class="due-date">Due date:</th><td class="due-date"></td></tr><tr><th class="assigned-to">Assignee:</th><td class="assigned-to">-</td><th class="progress">% Done:</th><td class="progress"><table class="progress progress-100" style="width: 80px;"><tr><td class="closed" style="width: 100%;"></td></tr></table><p class="percent">100%</p></td></tr><tr><th class="category">Category:</th><td class="category">&lt;multiple packages&gt;</td><th></th><td></td></tr><tr><th class="fixed-version">Target version:</th><td class="fixed-version"><a href="/versions/214">v6.7</a></td><th></th><td></td></tr>
<tr>
	<th class="cf_13">Resolution:</th><td class="cf_13"></td>
	<th class="cf_14">NEEDINFO:</th><td class="cf_14">No</td>
</tr>


</table>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Let's Encrypt (partial) support  | Let's Encrypt automatically generates and renews SSL certificates (see: <a class="external" href="https://letsencrypt.org/">https://letsencrypt.org/</a>).</p>


	<p>Prerequisites:</p>


	<ul>
	<li>the server must be reachable from outside at port 80</li>
		<li>the server must have at least one public domain name associated to its own public IP (technically a DNS record A or a CNAME)</li>
	</ul>


	<p>The system should support Let's Encrypt to generate certificates for the following domains:</p>


	<ul>
	<li>server FQDN</li>
		<li>custom domain names</li>
	</ul>


	<p>This implementation will have no web interface.</p>
  </div>
</div>






</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-base/revisions/5efaabc01ebf4bd7477481808be27cd1ee0709dd" title="Revision 5efaabc0">Revision 5efaabc0</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 04:09 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>Partial Let's Encrypt support. Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>


	<p>Use letsencrypt.sh client.<br />No python dependency required.</p>
    </div>
    </div>
    <div class="changeset even">
    <p><a href="/projects/nethserver/repository/nethserver-httpd/revisions/3534a3d11415be0b823e18b2fa3d8cfb9e95d4a9" title="Revision 3534a3d1">Revision 3534a3d1</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 05:59 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>Partial Let's Encrypt support. Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>
    </div>
    </div>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-base/revisions/765bf3da29364afb9828819a3dd680921381c779" title="Revision 765bf3da">Revision 765bf3da</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 08:37 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>letsencrypt-certs: add command line options. Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>
    </div>
    </div>
    <div class="changeset even">
    <p><a href="/projects/nethserver/repository/nethserver-base/revisions/d5d17d76abdb46b5a40f087df8dd885c1b33620a" title="Revision d5d17d76">Revision d5d17d76</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 08:37 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>LetsEncrypt: add cron job renew script. Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>
    </div>
    </div>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-base/revisions/976c097f1c513c78afdb8e3f54895b077eeeea95" title="Revision 976c097f">Revision 976c097f</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-18" title="02/18/2016 05:48 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>letsencrypt-certs: support SAN for FQDN. Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>
    </div>
    </div>
    <div class="changeset even">
    <p><a href="/projects/nethserver/repository/nethserver-base/revisions/23a74363424f1a1088997434d849900ff5ae0172" title="Revision 23a74363">Revision 23a74363</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-18" title="02/18/2016 08:06 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>letsencrypt-certs: add to SAN only enabled alias. Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>
    </div>
    </div>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-httpd/revisions/7efbc0851e6eb653ca83ee0fbb4045152088cb60" title="Revision 7efbc085">Revision 7efbc085</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-22" title="02/22/2016 04:28 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>certificate-update: expand httpd ssl.conf Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>
    </div>
    </div>
    <div class="changeset even">
    <p><a href="/projects/nethserver/repository/nethserver-httpd/revisions/b71df31147a90f4cfab4eee70c069a3474f1229f" title="Revision b71df311">Revision b71df311</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-25" title="02/25/2016 10:46 AM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>Move Let's Encrypt implementation to nethserver-letsencrypt package Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>


	<p>This reverts commit 3534a3d11415be0b823e18b2fa3d8cfb9e95d4a9.</p>
    </div>
    </div>
    <div class="changeset odd">
    <p><a href="/projects/nethserver/repository/nethserver-base/revisions/44a63f48917446d6301691641019cd20348ec355" title="Revision 44a63f48">Revision 44a63f48</a><br />
        <span class="author">Added by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-25" title="02/25/2016 12:14 PM">over 5 years</a> ago</span></p>
    <div class="wiki">
        <p>Move Let's Encrypt implementation to nethserver-letsencrypt package. Refs <a href="/issues/3355" class="issue tracker-2 status-5 priority-4 priority-default closed" title="Let&#x27;s Encrypt (partial) support  (CLOSED)">#3355</a></p>
    </div>
    </div>

</div>

<div id="history">
<h3>History</h3>
  <div id="change-16985" class="journal has-details">
    <div id="note-1">
    <h4><a href="/issues/3355#note-1" class="journal-link">#1</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 03:12 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Description</strong> updated (<a href="/journals/diff/16985?detail_id=28680" title="View differences">diff</a>)</li>
       <li><strong>Category</strong> set to <i>&lt;multiple packages&gt;</i></li>
       <li><strong>Status</strong> changed from <i>NEW</i> to <i>TRIAGED</i></li>
       <li><strong>Assignee</strong> set to <i>Giacomo Sanchietti</i></li>
       <li><strong>Target version</strong> set to <i>v6.7</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>20</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-16986" class="journal has-details">
    <div id="note-2">
    <h4><a href="/issues/3355#note-2" class="journal-link">#2</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 03:19 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Description</strong> updated (<a href="/journals/diff/16986?detail_id=28686" title="View differences">diff</a>)</li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-16987" class="journal has-details">
    <div id="note-3">
    <h4><a href="/issues/3355#note-3" class="journal-link">#3</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 03:19 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Description</strong> updated (<a href="/journals/diff/16987?detail_id=28687" title="View differences">diff</a>)</li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-16988" class="journal has-details">
    <div id="note-4">
    <h4><a href="/issues/3355#note-4" class="journal-link">#4</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 03:59 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>TRIAGED</i> to <i>ON_DEV</i></li>
       <li><strong>% Done</strong> changed from <i>20</i> to <i>30</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-16989" class="journal has-notes has-details">
    <div id="note-5">
    <h4><a href="/issues/3355#note-5" class="journal-link">#5</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 08:52 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_DEV</i> to <i>MODIFIED</i></li>
       <li><strong>% Done</strong> changed from <i>30</i> to <i>60</i></li>
    </ul>
    <div class="wiki" id="journal-16989-notes"><p>Current implementations uses letsencrypt.sh alternative client to avoid python dependencies.<br />See: <a class="external" href="https://github.com/NethServer/letsencrypt.sh">https://github.com/NethServer/letsencrypt.sh</a></p>


When Let's Encrypt is enabled, the system will create and automatically renew:
	<ul>
	<li>a certificate for server FQDN</li>
		<li>a certificate for each domain enabled inside the <code>certificates</code> database</li>
	</ul>


	<p>When a certificate has been generated or renewed, the <code>certificate-update</code> event will be fired.</p>


	<p>To globally enable Let's Encrypt:<br /><pre>
config setprop pki LetsEncrypt enabled
/usr/libexec/nethserver/letsencrypt-certs -v
</pre></p>


	<p>Add a custom domain:<br /><pre>
db certificates set neth.uk.to certificate status enabled
/usr/libexec/nethserver/letsencrypt-certs -v
</pre></p>


Available extra options:
	<ul>
	<li>LetsEncryptMail: if set, Let's Encrypt server will send notification messages to this mail address</li>
		<li>LetsEncryptRenewDays: minimum days before expiration to automatically renew certificate</li>
	</ul>


	<p><strong>NOTE</strong>: nethserver-httpd package is required, but could be not installed in all systems. Before trying Let's Encrypt, assure the package is installed: <code>yum install nethserver-httpd</code></p></div>
    </div>
  </div>
  
  <div id="change-16990" class="journal has-notes has-details">
    <div id="note-6">
    <h4><a href="/issues/3355#note-6" class="journal-link">#6</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-17" title="02/17/2016 09:18 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>MODIFIED</i> to <i>ON_QA</i></li>
       <li><strong>Assignee</strong> deleted (<del><i>Giacomo Sanchietti</i></del>)</li>
       <li><strong>% Done</strong> changed from <i>60</i> to <i>70</i></li>
    </ul>
    <div class="wiki" id="journal-16990-notes">Packages in nethserver-testing:
	<ul>
	<li>nethserver-base-2.9.5-1.3.gd5d17d7.ns6.noarch.rpm</li>
		<li>letsencrypt.sh-0.0.1-1.ns6.noarch.rpm</li>
		<li>nethserver-httpd-2.5.1-1.1.g3534a3d.ns6.noarch.rpm</li>
	</ul>


	<p>Before starting the QA, prepare the system:<br />1. Make sure your port 80 is open to the public Internet, you can check with sites like <a class="external" href="http://www.canyouseeme.org/">http://www.canyouseeme.org/</a><br />2. Make sure you have a public DNS name pointing to your server, you can check with sites like <a class="external" href="http://viewdns.info/">http://viewdns.info/</a> or <code>dig</code> and <code>host</code> commands<br />3. Make sure all packages are installed:<br /><pre>
yum --enablerepo=nethserver-testing install nethserver-base nethserver-httpd
</pre></p>


	<p><strong>NOTE</strong>: Let’s Encrypt has stringent rate limits in place during the public beta period. If you start testing using the production endpoint (which is the default), you will quickly hit these limits and find yourself locked out. To avoid this, execute <code>nethserver/letsencrypt-certs</code> command with <strong>-t</strong> option. Generated certificate will NOT be valid, and released by "happy hacker fake CA" CA.</p>


<strong>Test case 1</strong>
	<ul>
	<li>Enable Let's Encrypt: <code>config setprop pki LetsEncrypt enabled</code></li>
		<li>Execute the renew command <code>/usr/libexec/nethserver/letsencrypt-certs -v -t</code> and check for the output, should be something like:<br /><pre>
# INFO: Using main config file /tmp/3XhzEPg7Dt
+ Generating account key...
+ Registering account key with letsencrypt...
Processing test1.neth.eu
 + Signing domains...
 + Creating new directory /etc/letsencrypt.sh/certs/test1.neth.eu ...
 + Generating private key...
 + Generating signing request...
 + Requesting challenge for test1.neth.eu...
 + Responding to challenge for test1.neth.eu...
 + Challenge is valid!
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + Done!
Executing certificate-update event...
</pre></li>
		<li>Verify the presented certificate has been signed by Let's Encrypt CA on all SSL-enabled services like:
	<ul>
	<li>httpd on port 443</li>
		<li>httpd-admin on port 980</li>
		<li>etc</li>
	</ul></li>
	</ul>


<strong>Test case 2</strong>
	<ul>
	<li>Create a custom certificate record: <code>db certificates set mydomain certificate status enabled</code></li>
		<li>Create all certificates: <code>/usr/libexec/nethserver/letsencrypt-certs -v -t</code> </li>
		<li>Check new certificate files have been created under <code>/etc/letsencrypt.sh</code> directory</li>
	</ul>


<strong>Test case 3</strong>
	<ul>
	<li>Move the date forward (at least 21 days)</li>
		<li>Execute the script and check all certs are renewed: <code>/usr/libexec/nethserver/letsencrypt-certs -v -t</code></li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-17009" class="journal has-notes has-details">
    <div id="note-7">
    <h4><a href="/issues/3355#note-7" class="journal-link">#7</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-18" title="02/18/2016 05:10 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_QA</i> to <i>TRIAGED</i></li>
       <li><strong>Assignee</strong> set to <i>Giacomo Sanchietti</i></li>
       <li><strong>% Done</strong> changed from <i>70</i> to <i>20</i></li>
    </ul>
    <div class="wiki" id="journal-17009-notes"><p>Since Let's Encrypt supports x509 SAN extension, change the implementation to add all server alias as alternatives names.</p></div>
    </div>
  </div>
  
  <div id="change-17010" class="journal has-details">
    <div id="note-8">
    <h4><a href="/issues/3355#note-8" class="journal-link">#8</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-18" title="02/18/2016 05:10 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>TRIAGED</i> to <i>ON_DEV</i></li>
       <li><strong>% Done</strong> changed from <i>20</i> to <i>30</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-17011" class="journal has-details">
    <div id="note-9">
    <h4><a href="/issues/3355#note-9" class="journal-link">#9</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-18" title="02/18/2016 05:59 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_DEV</i> to <i>MODIFIED</i></li>
       <li><strong>% Done</strong> changed from <i>30</i> to <i>60</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-17012" class="journal has-notes has-details">
    <div id="note-10">
    <h4><a href="/issues/3355#note-10" class="journal-link">#10</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-18" title="02/18/2016 10:05 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>MODIFIED</i> to <i>ON_QA</i></li>
       <li><strong>Assignee</strong> deleted (<del><i>Giacomo Sanchietti</i></del>)</li>
       <li><strong>% Done</strong> changed from <i>60</i> to <i>70</i></li>
    </ul>
    <div class="wiki" id="journal-17012-notes">In nethserver-testing:
	<ul>
	<li>nethserver-base-2.9.5-1.5.g23a7436.ns6.noarch.rpm</li>
		<li>nethserver-httpd-2.5.1-1.2.g7efbc08.ns6.noarch.rpm</li>
		<li>letsencrypt.sh-0.0.1-1.ns6.noarch.rpm</li>
	</ul>


<strong>Test case 4</strong>
	<ul>
	<li>Create a server alias inside the DNS page</li>
		<li>Enable Let's Encrypt on server alias:<br /><pre>
db hosts setprop alias.mydomain.com LetsEncrypt enabled
</pre></li>
		<li>Make sure the alias has a public DNS record</li>
		<li>Regenerate all certificates:<br /><pre>
/usr/libexec/nethserver/letsencrypt-certs -v -t -f
</pre></li>
		<li>Check the generated certificate for FQDN contains all enabled aliases as alternative names:<br /><pre>
openssl x509 -in  /etc/letsencrypt.sh/certs/fqdn/cert.pem -text -noout | grep "Subject Alternative Name" -A 1
</pre></li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-17042" class="journal has-notes">
    <div id="note-11">
    <h4><a href="/issues/3355#note-11" class="journal-link">#11</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-25" title="02/25/2016 12:28 PM">over 5 years</a> ago</h4>

    <div class="wiki" id="journal-17042-notes">In nethserver-testing:
	<ul>
	<li>nethserver-base-2.9.5-1.7.g44a63f4.ns6.noarch.rpm</li>
		<li>nethserver-httpd-2.5.1-1.3.gb71df31.ns6.noarch.rpm</li>
		<li>nethserver-letsencrypt-0.0.1-1.ns6.noarch.rpm</li>
		<li>letsencrypt.sh-0.0.1-1.ns6.noarch.rpm</li>
	</ul>


Modifications:
	<ul>
	<li>Implementation moved to nethserver-letsencrypt package</li>
		<li>Testing mode doesn't apply any configuration to the system</li>
		<li>Testing mode now exits with 0 status case in case of success, 1 otherwise</li>
		<li>Support for custom certificates has been removed (was test case 2)</li>
	</ul>


	<p>Before starting the QA, prepare the system:<br />1. Make sure your port 80 is open to the public Internet, you can check with sites like <a class="external" href="http://www.canyouseeme.org/">http://www.canyouseeme.org/</a><br />2. Make sure you have a public DNS name pointing to your server, you can check with sites like <a class="external" href="http://viewdns.info/">http://viewdns.info/</a> or dig and host commands<br />3. Make sure all packages are installed:</p>


<pre>
yum --enablerepo=nethserver-testing install nethserver-letsencrypt nethserver-httpd
</pre>

	<p><strong>NOTE:</strong> Let’s Encrypt has stringent rate limits in place during the public beta period. If you start testing using the production endpoint (which is the default), you will quickly hit these limits and find yourself locked out. To avoid this, execute nethserver/letsencrypt-certs command with <strong>-t</strong> option. Generated certificate will NOT be valid, and released by "happy hacker fake CA" CA. Also, testing certificates will NOT be applied to running services.</p>


<strong>Test case 1</strong>
	<ul>
	<li>Enable Let's Encrypt: config setprop pki LetsEncrypt enabled</li>
		<li>Execute the renew command <code>/usr/libexec/nethserver/letsencrypt-certs -v -t</code> and check for the output, should be something like:<br /><pre>
INFO: Using main config file /tmp/3XhzEPg7Dt
+ Generating account key...
+ Registering account key with letsencrypt...
Processing test1.neth.eu
 + Signing domains...
 + Creating new directory /etc/letsencrypt.sh/certs/test1.neth.eu ...
 + Generating private key...
 + Generating signing request...
 + Requesting challenge for test1.neth.eu...
 + Responding to challenge for test1.neth.eu...
 + Challenge is valid!
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + Done!
</pre></li>
		<li>Check the certificate has been signed by  "happy hacker fake CA"</li>
	</ul>


<strong>Test case 2</strong>
	<ul>
	<li>Create a server alias inside the DNS page</li>
		<li>Enable Let's Encrypt on server alias:<br /><pre>
db hosts setprop alias.mydomain.com LetsEncrypt enabled
</pre></li>
		<li>Make sure the alias has a public DNS record</li>
		<li>Regenerate all certificates:<br /><pre>
/usr/libexec/nethserver/letsencrypt-certs -v -t -f
</pre></li>
		<li>Check the generated certificate for FQDN contains all enabled aliases as alternative names:<br /><pre>
openssl x509 -in  /etc/letsencrypt.sh/certs/fqdn/cert.pem -text -noout | grep "Subject Alternative Name" -A 1
</pre></li>
	</ul>


<strong>Test case 3</strong><br />WARNING: to test this case, you will need to generate a valid certificate!
	<ul>
	<li>Move the date forward (at least 21 days)</li>
		<li>Execute the script and check all certs are renewed: /usr/libexec/nethserver/letsencrypt-certs -v -t</li>
		<li>Check all services (port 443 and 980) are using the renewed certificate</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-17043" class="journal has-notes">
    <div id="note-12">
    <h4><a href="/issues/3355#note-12" class="journal-link">#12</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-26" title="02/26/2016 05:46 AM">over 5 years</a> ago</h4>

    <div class="wiki" id="journal-17043-notes">Packages in nethserver-testing:
	<ul>
	<li>nethserver-base-2.9.5-1.7.g44a63f4.ns6.noarch.rpm</li>
		<li>nethserver-httpd-2.5.1-1.3.gb71df31.ns6.noarch.rpm</li>
		<li>nethserver-letsencrypt-0.0.1-1.1.g33d204d.ns6.noarch.rpm</li>
		<li>letsencrypt.sh-0.0.1-1.ns6.noarch.rpm</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-17044" class="journal has-notes has-details">
    <div id="note-13">
    <h4><a href="/issues/3355#note-13" class="journal-link">#13</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/d1393faf88bfcbb0b41ce36307b6a143?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/8" class="user active">Filippo Carletti</a> <a href="/projects/nethserver/activity?from=2016-02-26" title="02/26/2016 06:02 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>ON_QA</i> to <i>VERIFIED</i></li>
       <li><strong>% Done</strong> changed from <i>70</i> to <i>90</i></li>
    </ul>
    <div class="wiki" id="journal-17044-notes"><p>I did tests on two different systems, one where I already used LE and one freshly installed.<br />Here's example output from a test (-t) run:<br /><pre>
[root@server ~]# db hosts setprop mail.fanolug.org LetsEncrypt enabled
[root@server ~]# /usr/libexec/nethserver/letsencrypt-certs -t -v
/usr/sbin/letsencrypt.sh --cron  --config /tmp/X7nCS_uLlQ/config.sh  -d server.xxx.com  -d gateway.xxx.com  -d mail.fanolug.org 
# INFO: Using main config file /tmp/X7nCS_uLlQ/config.sh
+ Generating account key...
+ Registering account key with letsencrypt...
Processing server.xxx.com with alternative names: gateway.xxx.com mail.fanolug.org
 + Signing domains...
 + Creating new directory /tmp/X7nCS_uLlQ/certs/server.xxx.com ...
 + Generating private key...
 + Generating signing request...
 + Requesting challenge for server.xxx.com...
 + Requesting challenge for gateway.xxx.com...
 + Requesting challenge for mail.fanolug.org...
 + Responding to challenge for server.xxx.com...
 + Challenge is valid!
 + Responding to challenge for gateway.xxx.com...
 + Challenge is valid!
 + Responding to challenge for mail.fanolug.org...
 + Challenge is valid!
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + Done!
</pre><br />Repeating the same test request command:<br /><pre>
[root@server ~]# /usr/libexec/nethserver/letsencrypt-certs -v -t
/usr/sbin/letsencrypt.sh --cron  --config /tmp/GJbu2wRF8Q  -d server.xxx.com  -d gateway.xxx.com 
# INFO: Using main config file /tmp/GJbu2wRF8Q
Processing server.xxx.com with alternative names: gateway.xxx.com
 + Checking domain name(s) of existing cert... unchanged.
 + Checking expire date of existing cert...
 + Valid till May 18 12:14:00 2016 GMT (Longer than 30 days). Skipping!
[root@server ~]# echo $?
0
</pre><br />Date moved forward:<br /><pre>
[root@nscom ~]# date 04252310
Mon Apr 25 23:10:00 CEST 2016
[root@nscom ~]# /usr/libexec/nethserver/letsencrypt-certs -v -t
/usr/sbin/letsencrypt.sh --cron  --config /tmp/jiitGmsQOf  -d fili.xxx.com 
# INFO: Using main config file /tmp/jiitGmsQOf
Processing fili.xxx.com
 + Checking domain name(s) of existing cert... unchanged.
 + Checking expire date of existing cert...
 + Valid till May 25 21:01:00 2016 GMT (Less than 30 days). Renewing!
 + Signing domains...
 + Generating signing request...
 + Requesting challenge for fili.xxx.com...
 + Responding to challenge for fili.xxx.com...
 + Challenge is valid!
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + Done!
Executing certificate-update event...
</pre></p>


	<p>While testing I received one error, I presume linked to the beta status of LE service:<br /><pre>
[root@nscom ~]# /usr/libexec/nethserver/letsencrypt-certs -v -t
/usr/sbin/letsencrypt.sh --cron  --config /tmp/Z5PCsd4Bs3  -d fili.xxx.com 
# INFO: Using main config file /tmp/Z5PCsd4Bs3
ERROR: Problem connecting to server (curl returned with 6)
</pre></p>


	<p>Note: moving the date forward is not a perfect way to test renewal, because the cert will always have the correct date, being created on LE servers.</p></div>
    </div>
  </div>
  
  <div id="change-17046" class="journal has-notes has-details">
    <div id="note-14">
    <h4><a href="/issues/3355#note-14" class="journal-link">#14</a>
    <img alt="" class="gravatar" default="wavatar" rating="PG" src="http://www.gravatar.com/avatar/557f8126150c57751ffc7d17a9f01e11?rating=PG&amp;size=24&amp;default=wavatar" ssl="false" title="" />
    Updated by <a href="/users/5" class="user active">Giacomo Sanchietti</a> <a href="/projects/nethserver/activity?from=2016-02-26" title="02/26/2016 08:44 AM">over 5 years</a> ago</h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>VERIFIED</i> to <i>CLOSED</i></li>
       <li><strong>% Done</strong> changed from <i>90</i> to <i>100</i></li>
    </ul>
    <div class="wiki" id="journal-17046-notes">Releases in nethserver-updates:
	<ul>
	<li>nethserver-base-2.9.6-1.ns6.noarch.rpm</li>
		<li>nethserver-httpd-2.5.2-1.ns6.noarch.rpm</li>
		<li>nethserver-letsencrypt-1.0.0-1.ns6.noarch.rpm</li>
		<li>letsencrypt.sh-0.0.1-1.ns6.noarch.rpm</li>
	</ul>


	<p>Temporary documentation: <a class="external" href="http://wiki.nethserver.org/doku.php?id=developer:letsencrypt">http://wiki.nethserver.org/doku.php?id=developer:letsencrypt</a></p></div>
    </div>
  </div>
  


</div>


<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>

<p class="other-formats">Also available in:  <span><a href="/issues/3355.atom" class="atom" rel="nofollow">Atom</a></span>
  <span><a href="/issues/3355.pdf" class="pdf" rel="nofollow">PDF</a></span>
</p>



<script type="text/javascript">
//<![CDATA[
contextMenuInit('/issues/context_menu')
//]]>
</script>

        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Copyright © 2012-2021 nethserver.org
  </div></div>
</div>
</div>
</div>

</body>
</html>
